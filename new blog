root/
â”œâ”€â”€ public/
â”‚   â””â”€â”€ env.js          # <- runtime env file (will be replaced dynamically)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ env.js      # <- env loader (supports both vite dev and runtime)
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â””â”€â”€ EnvContext.jsx # <- React context for env (optional but clean)
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ apiClient.js   # <- Axios client using dynamic base URL
â”‚   â”œâ”€â”€ App.jsx
â”‚   â”œâ”€â”€ main.jsx
â”œâ”€â”€ .env
â”œâ”€â”€ .env.production
â”œâ”€â”€ vite.config.js
â”œâ”€â”€ package.json
â”œâ”€â”€ Dockerfile
â””â”€â”€ nginx.conf


// public/env.js

window._env_ = {
  REACT_APP_API_URL: "https://api.production.com",
  REACT_APP_AUTH_URL: "https://auth.production.com",
  CONFIG_VERSION: "2025-04-21-01",
};


// src/config/env.js

const getEnvVar = (key, fallback = undefined) => {
  if (typeof window !== "undefined" && window._env_ && window._env_[key]) {
    return window._env_[key];
  }
  if (import.meta.env && import.meta.env[key]) {
    return import.meta.env[key];
  }
  return fallback;
};

export const ENV = {
  API_URL: getEnvVar('REACT_APP_API_URL'),
  AUTH_URL: getEnvVar('REACT_APP_AUTH_URL'),
  CONFIG_VERSION: getEnvVar('CONFIG_VERSION', 'unknown'),
};

export default ENV;



// src/api/apiClient.js

import axios from 'axios';
import { ENV } from '../config/env';

const apiClient = axios.create({
  baseURL: ENV.API_URL,
  timeout: 10000,
});

export default apiClient;




// src/context/EnvContext.jsx

import { createContext, useContext } from 'react';
import { ENV } from '../config/env';

const EnvContext = createContext(ENV);

export const useEnv = () => useContext(EnvContext);

export const EnvProvider = ({ children }) => {
  return (
    <EnvContext.Provider value={ENV}>
      {children}
    </EnvContext.Provider>
  );
};




// src/main.jsx

import React from 'react';
import { createRoot } from 'react-dom/client';
import App from './App';

async function bootstrapApp() {
  if (import.meta.env.PROD) {
    await loadEnvScript();
  }
  createRoot(document.getElementById('root')).render(<App />);
}

function loadEnvScript() {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = '/env.js?v=' + Date.now(); // bust cache
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

bootstrapApp();


import { EnvProvider } from './context/EnvContext';

function App() {
  return (
    <EnvProvider>
      <div>Hello Dynamic Environment Setup!</div>
    </EnvProvider>
  );
}

export default App;


# Dockerfile

FROM node:18-alpine as builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
COPY public/env.js /usr/share/nginx/html/env.js


# nginx.conf

server {
  listen 80;
  server_name _;

  location / {
    root   /usr/share/nginx/html;
    index  index.html;
    try_files $uri $uri/ /index.html;
  }

  location /env.js {
    root /usr/share/nginx/html;
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
  }
}

ðŸ§  Kubernetes ConfigMap or Docker volume for env.js (dynamic injection)

apiVersion: v1
kind: ConfigMap
metadata:
  name: my-app-env
data:
  env.js: |
    window._env_ = {
      REACT_APP_API_URL: "https://api.staging.com",
      REACT_APP_AUTH_URL: "https://auth.staging.com",
      CONFIG_VERSION: "staging-2025",
    };





------------------------------------



# Step 1: Use the base node image to build your app
FROM node:18-alpine as builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# Step 2: Use nginx for serving the app
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

# Step 3: Add the dynamic env.js generation during container start
COPY ./public/env.js.template /usr/share/nginx/html/env.js.template

# Inject the environment variables into env.js at container start
CMD envsubst < /usr/share/nginx/html/env.js.template > /usr/share/nginx/html/env.js && nginx -g "daemon off;"



window._env_ = {
  REACT_APP_API_URL: "${REACT_APP_API_URL}",
  REACT_APP_AUTH_URL: "${REACT_APP_AUTH_URL}",
  CONFIG_VERSION: "${CONFIG_VERSION}",
};



import React from 'react';
import { createRoot } from 'react-dom/client';
import App from './App';

async function bootstrapApp() {
  if (import.meta.env.PROD) {
    await loadEnvScript();
  }
  createRoot(document.getElementById('root')).render(<App />);
}

function loadEnvScript() {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = '/env.js?v=' + Date.now(); // Cache busting
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

bootstrapApp();



const getEnvVar = (key, fallback = undefined) => {
  if (typeof window !== "undefined" && window._env_ && window._env_[key]) {
    return window._env_[key];
  }
  if (import.meta.env && import.meta.env[key]) {
    return import.meta.env[key];
  }
  return fallback;
};

export const ENV = {
  API_URL: getEnvVar('REACT_APP_API_URL'),
  AUTH_URL: getEnvVar('REACT_APP_AUTH_URL'),
  CONFIG_VERSION: getEnvVar('CONFIG_VERSION', 'unknown'),
};

export default ENV;


import axios from 'axios';
import { ENV } from '../config/env';

const apiClient = axios.create({
  baseURL: ENV.API_URL,
  timeout: 10000,
});

export default apiClient;


server {
  listen 80;
  server_name _;

  location / {
    root   /usr/share/nginx/html;
    index  index.html;
    try_files $uri $uri/ /index.html;
  }

  location /env.js {
    root /usr/share/nginx/html;
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
  }
}


docker build -t react-vite-env .


docker run -p 80:80 -e REACT_APP_API_URL=https://api.example.com -e REACT_APP_AUTH_URL=https://auth.example.com react-vite-env
----------
-----

# Step 1: Build stage
FROM node:18-alpine as builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# Step 2: Production stage
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html/rui  # ðŸ‘ˆ put under /rui
COPY nginx.conf /etc/nginx/nginx.conf
COPY ./public/env.js.template /usr/share/nginx/html/rui/env.js.template

# Step 3: Inject env vars at start
CMD envsubst < /usr/share/nginx/html/rui/env.js.template > /usr/share/nginx/html/rui/env.js && nginx -g "daemon off;"


server {
  listen 80;
  server_name _;

  location /rui/ {
    root   /usr/share/nginx/html;
    index  index.html;
    try_files $uri $uri/ /rui/index.html;
  }

  location /rui/env.js {
    root /usr/share/nginx/html;
    add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
  }
}



---------------------

docker build -t react-vite-env .
docker run -d --name my-app-container \
  -p 9001:80 \
  -e REACT_APP_API_URL="https://api.staging.example.com" \
  -e REACT_APP_AUTH_URL="https://auth.staging.example.com" \
  -e CONFIG_VERSION="staging-2025" \
  react-vite-env

----------------------
Step 1: Create a ConfigMap with env.js Template
âœ… Create a ConfigMap like this:


apiVersion: v1
kind: ConfigMap
metadata:
  name: rui-env-configmap
data:
  env.js.template: |
    window._env_ = {
      REACT_APP_API_URL: "${REACT_APP_API_URL}",
      REACT_APP_AUTH_URL: "${REACT_APP_AUTH_URL}",
      CONFIG_VERSION: "${CONFIG_VERSION}",
    };


(Here env.js.template is created dynamically at runtime inside the pod)

Step 2: Update your Kubernetes Deployment
In your Pod spec.template.spec:

âœ… 1. Mount the ConfigMap inside the container
âœ… 2. Set Environment Variables dynamically
âœ… 3. Inject envsubst command before starting nginx

Hereâ€™s a sample deployment snippet:
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rui-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rui-app
  template:
    metadata:
      labels:
        app: rui-app
    spec:
      containers:
      - name: rui-container
        image: your-docker-image:latest
        ports:
        - containerPort: 80
        env:
        - name: REACT_APP_API_URL
          value: "https://api.production.com"
        - name: REACT_APP_AUTH_URL
          value: "https://auth.production.com"
        - name: CONFIG_VERSION
          value: "prod-2025"
        volumeMounts:
        - name: env-config-volume
          mountPath: /usr/share/nginx/html/env.js.template
          subPath: env.js.template
        command: ["/bin/sh", "-c"]
        args:
          - envsubst < /usr/share/nginx/html/env.js.template > /usr/share/nginx/html/rui/env.js && nginx -g 'daemon off;'
      volumes:
      - name: env-config-volume
        configMap:
          name: rui-env-configmap




