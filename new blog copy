const express = require('express');
const axios = require('axios');
const app = express();

// Enable CORS for all routes
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, HEAD');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, git-protocol');
    res.header('Access-Control-Expose-Headers', 'Content-Type, Content-Length, Content-Encoding, Cache-Control, ETag, Link, Location, Git-Protocol');

    if (req.method === 'OPTIONS') {
        return res.sendStatus(200);
    }
    next();
});

// Proxy handler
app.all(/.*/, async (req, res) => {
    // isomorphic-git sends requests like http://proxy/https://github.com/user/repo.git/...
    // Sometimes it might come through as //github.com/... if protocol is stripped or malformed.

    // Strip all leading slashes
    let targetUrl = req.url;
    while (targetUrl.startsWith('/')) {
        targetUrl = targetUrl.slice(1);
    }

    // specific hack: if it starts with 'https:/' but not 'https://' (sometimes happens with double slash reduction)
    if (targetUrl.startsWith('http:/') && !targetUrl.startsWith('http://')) {
        targetUrl = targetUrl.replace('http:/', 'http://');
    }
    if (targetUrl.startsWith('https:/') && !targetUrl.startsWith('https://')) {
        targetUrl = targetUrl.replace('https:/', 'https://');
    }

    // Check if query param ?url= exists (some clients might use that)
    if (req.query.url) {
        targetUrl = req.query.url;
    }

    // If still no protocol, assume https:// for github.com URLs or general use
    if (!targetUrl.startsWith('http')) {
        targetUrl = `https://${targetUrl}`;
    }

    if (!targetUrl.startsWith('http')) {
        console.error('Invalid Target URL (after processing):', targetUrl, 'Original:', req.url);
        return res.status(400).send('Invalid URL format. Expected proxy usage: /<target_url>');
    }

    console.log(`Proxying ${req.method} to: ${targetUrl}`);

    try {
        const response = await axios({
            method: req.method,
            url: targetUrl,
            headers: {
                // Forward key headers
                'User-Agent': req.headers['user-agent'] || 'git-proxy',
                'Accept': req.headers['accept'],
                'Content-Type': req.headers['content-type'],
                'Git-Protocol': req.headers['git-protocol'],
                'Authorization': req.headers['authorization'],
            },
            data: req, // Forward the request stream directly
            responseType: 'stream', // Important for git smart http
            validateStatus: () => true, // Don't throw on error status
        });

        // Copy response headers
        Object.entries(response.headers).forEach(([key, value]) => {
            res.setHeader(key, value);
        });

        res.status(response.status);
        response.data.pipe(res);

    } catch (error) {
        console.error('Proxy Error:', error.message);
        if (!res.headersSent) {
            res.status(502).send('Proxy Error: ' + error.message);
        }
    }
});

const PORT = 9999;
app.listen(PORT, '0.0.0.0', () => {
    console.log(`Express Proxy running on port ${PORT}`);
});


{
    "name": "github-file-explorer-backend",
    "version": "1.0.0",
    "description": "CORS Proxy for GitHub File Explorer",
    "main": "server.js",
    "scripts": {
        "start": "node server.js"
    },
    "keywords": [],
    "author": "",
    "license": "ISC",
    "dependencies": {
        "axios": "^1.13.4",
        "express": "^5.2.1"
    }
}
